## File Structure

```
next-pagination-pages/
└── app
    ├── movies
    │   ├── await.tsx
    │   ├── loading.tsx
    │   ├── movies.tsx
    │   ├── page.tsx
    │   ├── search.tsx
    │   ├── skeleton.tsx
    │   └── trigger.tsx
    ├── globals.css
    ├── layout.tsx
    └── page.tsx
```

### `app/globals.css`

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --foreground-rgb: 0, 0, 0;
  --background-start-rgb: 214, 219, 220;
  --background-end-rgb: 255, 255, 255;
}

@media (prefers-color-scheme: dark) {
  :root {
    --foreground-rgb: 255, 255, 255;
    --background-start-rgb: 0, 0, 0;
    --background-end-rgb: 0, 0, 0;
  }
}

body {
  color: rgb(var(--foreground-rgb));
  background: linear-gradient(
      to bottom,
      transparent,
      rgb(var(--background-end-rgb))
    ) rgb(var(--background-start-rgb));
}
```

### `app/layout.tsx`

```typescript
import "./globals.css";
import Link from "next/link";
import type { Metadata } from "next";
import { Inter } from "next/font/google";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <header className="py-8">
          <nav className="container">
            <ul className="flex space-x-6">
              <li>
                <Link href="/">Home</Link>
              </li>
              <li>
                <Link href="/movies">Movies</Link>
              </li>
            </ul>
          </nav>
        </header>

        <main>{children}</main>
      </body>
    </html>
  );
}
```

### `app/movies/await.tsx`

```typescript
export default async function Await<T>({
  promise,
  children,
}: {
  promise: Promise<T>;
  children: (value: T) => JSX.Element;
}) {
  let data = await promise;

  return children(data);
}
```

### `app/movies/loading.tsx`

```typescript
const Loading = () => {
  return (
    <section className="py-24">
      <div className="container">
        <h2>Loading...</h2>
      </div>
    </section>
  );
};

export default Loading;
```

### `app/movies/movies.tsx`

```typescript
import Image from "next/image";
import { Document } from "mongodb";

export default function Movies({ movies }: { movies: Document[] | undefined }) {
  return (
    <ul
      role="list"
      className="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2 sm:gap-x-6 md:grid-cols-3 lg:grid-cols-4 xl:gap-x-8"
    >
      {movies?.map((movie) => (
        <li key={movie._id.toString()} className="relative">
          <div className="group block aspect-square w-full overflow-hidden rounded-lg bg-gray-100">
            <Image
              src={movie.poster}
              alt=""
              className="object-cover group-hover:opacity-75"
              width={300}
              height={300}
            />
          </div>
          <p className="mt-2 block truncate font-medium">{movie.title}</p>
          <p className="block text-sm font-medium text-gray-500">
            {movie.cast?.join(", ")}
          </p>
          <p className="block text-sm font-medium text-gray-500">
            {movie.year}
          </p>
        </li>
      ))}
    </ul>
  );
}
```

### `app/movies/page.tsx`

```typescript
import clsx from "clsx";
import Link from "next/link";
import { Suspense } from "react";
import { v4 as uuid } from "uuid";

import { getMovies } from "@/lib/mongo/movies";

import Search from "./search";
import Movies from "./movies";
import Await from "./await";
import Skeleton from "./skeleton";

const Page = async ({
  searchParams,
}: {
  searchParams: { [key: string]: string | string[] | undefined };
}) => {
  const page =
    typeof searchParams.page === "string" ? Number(searchParams.page) : 1;
  const limit =
    typeof searchParams.limit === "string" ? Number(searchParams.limit) : 10;

  const search =
    typeof searchParams.search === "string" ? searchParams.search : undefined;

  const promise = getMovies({ page, limit, query: search });

  return (
    <section className="py-24" key={uuid()}>
      <div className="container">
        <div className="mb-12 flex items-center justify-between gap-x-16">
          <h1 className="text-3xl font-bold">Movies</h1>

          <div className="grow">
            <Search search={search} />
          </div>

          <div className="flex space-x-6">
            <Link
              href={{
                pathname: "/movies",
                query: {
                  ...(search ? { search } : {}),
                  page: page > 1 ? page - 1 : 1,
                },
              }}
              className={clsx(
                "rounded border bg-gray-100 px-3 py-1 text-sm text-gray-800",
                page <= 1 && "pointer-events-none opacity-50"
              )}
            >
              Previous
            </Link>
            <Link
              href={{
                pathname: "/movies",
                query: {
                  ...(search ? { search } : {}),
                  page: page + 1,
                },
              }}
              className="rounded border bg-gray-100 px-3 py-1 text-sm text-gray-800"
            >
              Next
            </Link>
          </div>
        </div>

        <Suspense fallback={<Skeleton />}>
          <Await promise={promise}>
            {({ movies }) => <Movies movies={movies} />}
          </Await>
        </Suspense>
      </div>
    </section>
  );
};

export default Page;
```

### `app/movies/search.tsx`

```typescript
"use client";

import { useEffect, useRef, useState } from "react";
import { useRouter } from "next/navigation";
import { MagnifyingGlassIcon } from "@heroicons/react/20/solid";
import { useDebounce } from "use-debounce";

const Search = ({ search }: { search?: string }) => {
  const router = useRouter();
  const initialRender = useRef(true);

  const [text, setText] = useState(search);
  const [query] = useDebounce(text, 750);

  useEffect(() => {
    if (initialRender.current) {
      initialRender.current = false;
      return;
    }

    if (!query) {
      router.push(`/movies`);
    } else {
      router.push(`/movies?search=${query}`);
    }
  }, [query]);

  return (
    <div className="relative rounded-md shadow-sm">
      <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
        <MagnifyingGlassIcon
          className="h-5 w-5 text-gray-400"
          aria-hidden="true"
        />
      </div>
      <input
        value={text}
        placeholder="Search movies..."
        onChange={(e) => setText(e.target.value)}
        className="block w-full rounded-md border-0 py-1.5 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-sky-600 sm:text-sm sm:leading-6"
      />
    </div>
  );
};

export default Search;
```

### `app/movies/skeleton.tsx`

```typescript
export default function Skeleton() {
  return (
    <ul className="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2 sm:gap-x-6 md:grid-cols-3 lg:grid-cols-4 xl:gap-x-8">
      {[...Array(10)].map((movie, index) => (
        <li key={index} className="relative animate-pulse">
          <div className="aspect-square h-[300] w-full overflow-hidden rounded-lg bg-gray-300"></div>
          <p className="mt-2 h-4 w-1/2 rounded-lg bg-gray-600"></p>
          <p className="mt-2 block h-4 rounded-lg bg-gray-600 text-sm font-medium"></p>
          <p className="mt-2 block h-4 rounded-lg bg-gray-600 text-sm font-medium"></p>
        </li>
      ))}
    </ul>
  );
}
```

### `app/movies/trigger.tsx`

```typescript
"use client";

import { useCallback } from "react";
import { useRouter } from "next/navigation";

const Trigger = ({ limit }: { limit: number }) => {
  const router = useRouter();

  const TriggerRef = useCallback(
    (node: any) => {
      if (!node) return;

      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            router.push(`/movies?limit=${limit + 10}`, { scroll: false });
            observer.disconnect();
          }
        });
      });

      observer.observe(node);
    },
    [limit]
  );

  return <div ref={TriggerRef} className="h-1 w-1 bg-red-400"></div>;
};

export default Trigger;
```

### `app/page.tsx`

```typescript
const Home = () => {
  return (
    <section className="py-24">
      <div className="container">
        <h1 className="text-3xl font-bold">NextJs 13 Server Side Pagination</h1>
      </div>
    </section>
  );
};

export default Home;
```

## File Structure

```
next-pagination-pages/
└── lib
    └── mongo
        ├── client.ts
        └── movies.ts
```

### `lib/mongo/client.ts`

```typescript
import { MongoClient } from "mongodb";

const uri = process.env.MONGODB_URI as string;
const options = {};

declare global {
  var _mongoClientPromise: Promise<MongoClient>;
}

class Singleton {
  private static _instance: Singleton;
  private client: MongoClient;
  private clientPromise: Promise<MongoClient>;
  private constructor() {
    this.client = new MongoClient(uri, options);
    this.clientPromise = this.client.connect();
    if (process.env.NODE_ENV === "development") {
      global._mongoClientPromise = this.clientPromise;
    }
  }

  public static get instance() {
    if (!this._instance) {
      this._instance = new Singleton();
    }
    return this._instance.clientPromise;
  }
}
const clientPromise = Singleton.instance;

export default clientPromise;
```

### `lib/mongo/movies.ts`

```typescript
import { Collection, Db, Document, MongoClient } from "mongodb";
import clientPromise from "@/lib/mongo/client";

let client: MongoClient;
let db: Db;
let movies: Collection<Document>;

async function init() {
  if (db) return;
  try {
    client = await clientPromise;
    db = client.db();
    movies = db.collection("movies");
  } catch (error) {
    throw new Error("Failed to connect to the database.");
  }
}

// Avoid exhausting your connection
// ;(async () => {
//   await init()
// })()

/// Movies ///

export const getMovies = async ({
  query,
  page = 1,
  limit = 10,
}: {
  query?: string;
  page: number;
  limit: number;
}) => {
  try {
    if (!movies) await init();

    const skip = (page - 1) * limit;

    const pipeline: PipelineStage[] = [{ $skip: skip }, { $limit: limit }];

    if (query) {
      pipeline.unshift({
        $search: {
          index: "search",
          text: {
            query,
            fuzzy: {
              maxEdits: 1,
              prefixLength: 3,
              maxExpansions: 50,
            },
            path: {
              wildcard: "*",
            },
          },
        },
      });
    }

    await sleep(1000);

    const result = await movies.aggregate(pipeline).toArray();

    return { movies: result };
  } catch (error) {
    return { error };
  }
};

async function sleep(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

type PipelineStage =
  | {
      $search: {
        index: string;
        text: {
          query: string;
          fuzzy: {};
          path: {
            wildcard: string;
          };
        };
      };
    }
  | {
      $skip: number;
    }
  | {
      $limit: number;
    };
```
